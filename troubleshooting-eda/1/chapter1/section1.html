<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Troubleshooting the rulebook using CURL :: Product Enablement: Event-Driven Ansible Troubleshooting Lab</title>
    <link rel="prev" href="index.html">
    <link rel="next" href="section2.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/troubleshooting-eda/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="troubleshooting-eda" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section1.html">Troubleshooting the rulebook using CURL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section2.html">Troubleshoot rulebook using CURL and extra_vars</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section3.html">Configure Event-Driven to pass extra variables to Ansible Automation Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section4.html">Configure Event-Driven to pass extra variables to Ansible Automation Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section5.html">Let&#8217;s configure Event-Driven and Ansible Automation Platform to fix issues coming from Zabbix</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Product Enablement: Event-Driven Ansible Troubleshooting Lab</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a></li>
    <li><a href="section1.html">Troubleshooting the rulebook using CURL</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Troubleshooting the rulebook using CURL</h1>
<div class="sect1">
<h2 id="in_this_bfx"><a class="anchor" href="#in_this_bfx"></a>What is in this break-fix section</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you will explore the basic artifacts of Event-Driven Ansible (Automation Decisions), troubleshoot the error encountered while executing <code>ansible-rulebook</code>, and verify functionality after resolving the issue.</p>
</div>
<div class="paragraph">
<p>What is <code>ansible-rulebook</code>? The <code>ansible-rulebook</code> command is similar to <code>ansible-playbook</code>, but more oriented to "if-then" scenarios.</p>
</div>
<div class="paragraph">
<p>A rulebook consists of three main components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Sources</strong> define which event source we will use. These sources come from source plugins which have been built to accommodate common use cases. Some of the source plugins that are currently available include webhooks, Kafka, Azure service bus, file changes, and alertmanager.</p>
</li>
<li>
<p><strong>Rules</strong> define conditionals we will try to match from the event source. Should the condition be met, then we can trigger an action.</p>
</li>
<li>
<p><strong>Actions</strong> trigger what need to happen should a condition be met. Some of the current actions are: <em>run_playbook</em>, <em>run_module</em>, <em>set_fact</em>, <em>post_event</em>, and <em>debug</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the below steps to proceed with the activity:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From <strong>bastion</strong>, access the <strong>node1</strong> instance via SSH.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ssh node1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[lab-user@bastion ~]$ ssh node1
Last login: Fri Nov 29 06:30:21 2024 from 192.168.0.33
[ec2-user@node1 ~]$</pre>
</div>
</div>
</li>
<li>
<p>Navigate to the <em>01-lab</em> directory.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd 01-lab
ls</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 ~]$ cd 01-lab/
[ec2-user@node1 01-lab]$ ls
hello-rh1.yml  inventory.yml  webhook-example.yml
[ec2-user@node1 01-lab]$</pre>
</div>
</div>
</li>
<li>
<p>Check the rulebook, playbook, and inventory files in the lab directory and try to understand their purpose.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">less webhook-example.yml
less hello-rh1.yml
less inventory.yml</code></pre>
</div>
</div>
</li>
<li>
<p>From the lab&#8217;s directory in the terminal, run the <code>ansible-rulebook</code> command as shown below.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 01-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events
2024-11-29 09:10:42,817 - ansible_rulebook.app - INFO - Starting sources
2024-11-29 09:10:42,818 - ansible_rulebook.app - INFO - Starting rules

. . .

2024-11-29 09:10:44,543 - ansible_rulebook.engine - ERROR - Source error Could not find source plugin for ansible.eda.webhook
2024-11-29 09:10:44,543 - ansible_rulebook.engine - ERROR - Shutting down source: ansible.eda.webhook error : Could not find source plugin for ansible.eda.webhook
2024-11-29 09:10:44,546 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end

. . .

2024-11-29 09:10:44,646 - ansible_rulebook.engine - INFO - Cancelling all ruleset tasks
2024-11-29 09:10:44,646 - ansible_rulebook.app - INFO - Cancelling event source tasks
2024-11-29 09:10:44,653 - ansible_rulebook.app - ERROR - Could not find source plugin for ansible.eda.webhook
2024-11-29 09:10:44,653 - ansible_rulebook.app - INFO - Main complete
2024-11-29 09:10:44,655 - ansible_rulebook.cli - ERROR - Terminating One of the source plugins failed
[ec2-user@node1 01-lab]$</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is your first troubleshooting task: <strong>"ERROR - Terminating One of the source plugins failed."</strong>
Please resolve this issue before proceeding to the next step.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the <code>ansible-rulebook</code> command is still running, press kbd:[Ctrl+C] in the <code>node1</code> terminal and stop it.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>After fixing the above issue, run the <code>ansible-rulebook</code> command again to verify the fix.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>. . .
2024-12-16 11:08:32,462 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-12-16 11:08:32,463 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-12-16 11:08:32,463 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook</pre>
</div>
</div>
</li>
<li>
<p>With the <code>ansible-rulebook</code> running on the <code>node1</code> terminal, access the second terminal and run the <code>curl</code> command from <code>bastion</code> host to proceed.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -H 'Content-Type: application/json' -d '{"event_name:" "Hello" }' node1:5000/endpoint</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>Invalid JSON payload</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
WARNING - Wrong body request: failed to decode JSON payload
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Attempt to fix the error generated by the <strong>curl</strong> command.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you encounter the error <strong>"curl: (7) Failed to connect to node1 port 5000: Connection refused"</strong>, this means that the <code>ansible-rulebook</code> command is not running on <strong>node1</strong>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This concludes your first troubleshooting activity. Please press <code>[Ctrl-C]</code> to exit the <code>ansible-rulebook</code> on <strong>node1</strong> and proceed to the next activity.</p>
</div>
<hr>
<div class="paragraph">
<p><strong>PAUSE</strong>
'''</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_moving_ahead"><a class="anchor" href="#_before_moving_ahead"></a>Before moving ahead</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_please_take_a_moment_to_solve_the_challenge_on_your_own"><a class="anchor" href="#_please_take_a_moment_to_solve_the_challenge_on_your_own"></a>Please take a moment to solve the challenge on your own.</h3>
<div class="paragraph">
<p><strong>The real value of this lies in your effort to troubleshoot independently.</strong></p>
</div>
<div class="paragraph">
<p><strong>Once you have tried, continue to the next section for guided steps to verify your approach or learn an alternate solution.</strong></p>
</div>
<hr>
<div class="paragraph">
<p><strong>CONTINUE</strong>
'''</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guided_solution"><a class="anchor" href="#guided_solution"></a>Guided solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Note the errors related to the Ansible EDA plugin in the output generated by the <code>ansible-rulebook</code> command.</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>ERROR - Could not find source plugin for ansible.eda.webhook
...
ERROR - Terminating One of the source plugins failed</pre>
</div>
</div>
</li>
<li>
<p>Install the Ansible Galaxy collection <em>ansible.eda</em>.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ansible-galaxy collection install ansible.eda</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 01-lab]$ ansible-galaxy collection install ansible.eda
Starting galaxy collection install process
Process install dependency map
Starting collection install process
Downloading https://galaxy.ansible.com/api/v3/plugin/ansible/content/published/collections/artifacts/ansible-eda-2.2.0.tar.gz to /home/ec2-user/.ansible/tmp/ansible-local-31890ne19swmy/tmp9ok98ogw/ansible-eda-2.2.0-r410por3
Installing 'ansible.eda:2.2.0' to '/home/ec2-user/.ansible/collections/ansible_collections/ansible/eda'
ansible.eda:2.2.0 was installed successfully
[ec2-user@node1 01-lab]$</pre>
</div>
</div>
</li>
<li>
<p>Run the <code>ansible-rulebook</code> command again.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 01-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events
2024-11-29 09:18:25,916 - ansible_rulebook.app - INFO - Starting sources
2024-11-29 09:18:25,916 - ansible_rulebook.app - INFO - Starting rules
2024-11-29 09:18:25,917 - drools.ruleset - INFO - Using jar: /usr/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.6.Final-redhat-00001.jar
2024-11-29 09:18:27 088 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-11-29 09:18:27,116 - ansible_rulebook.engine - INFO - load source ansible.eda.webhook
2024-11-29 09:18:27,863 - ansible_rulebook.engine - INFO - loading source filter eda.builtin.insert_meta_info
2024-11-29 09:18:28,601 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-11-29 09:18:28 601 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected
2024-11-29 09:18:28,602 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-11-29 09:18:28,602 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the command does not error out and waits to listen for events on the webhook.</p>
</div>
</li>
<li>
<p>In another terminal, run the <code>curl</code> command from the bastion host.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -H 'Content-Type: application/json' -d '{"event_name": "Hello" }' node1:5000/endpoint</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice how the semicolon was originally on the inside of the double quotation mark, but in the command above it is on the outside of it.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Go back to the terminal where the <code>ansible-rulebook</code> command was running and observe the output generated.</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>. . .

** 2024-11-29 09:22:07.667842 [received event] ******************************************************************************************************
Ruleset: Listen for events on a webhook
Event:
{'meta': {'endpoint': 'endpoint',
          'headers': {'Accept': '*/*',
                      'Content-Length': '24',
                      'Content-Type': 'application/json',
                      'Host': 'node1:5000',
                      'User-Agent': 'curl/7.76.1'},
          'received_at': '2024-11-29T09:22:07.666975Z',
          'source': {'name': 'ansible.eda.webhook',
                     'type': 'ansible.eda.webhook'},
          'uuid': '5a9303b6-4863-4be7-b0da-7367afc21d6f'},
 'payload': {'event_name': 'Hello'}}
*****************************************************************************************************************************************************
2024-11-29 09:22:07 672 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.MemoryMonitorUtil - Memory occupation threshold set to 90%
2024-11-29 09:22:07 672 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.MemoryMonitorUtil - Memory check event count threshold set to 64
2024-11-29 09:22:07 672 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.MemoryMonitorUtil - Exit above memory occupation threshold set to false

PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [debug] *******************************************************************
ok: [localhost] =&gt; {
    "msg": "Hello RH1"
}

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
2024-11-29 09:22:11,026 - ansible_rulebook.action.runner - INFO - Ansible runner Queue task cancelled
2024-11-29 09:22:11,027 - ansible_rulebook.action.run_playbook - INFO - Ansible runner rc: 0, status: successful</pre>
</div>
</div>
<div class="paragraph">
<p>Observe that Event-Driven captured the <strong>Hello</strong> event as mentioned in the rulebook and executed the playbook to print the <strong>Hello RH1</strong> message.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Press kbd:[Ctrl-C] to exit the <code>ansible-rulebook</code> on <strong>node1</strong>.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a></span>
  <span class="next"><a href="section2.html">Troubleshoot rulebook using CURL and extra_vars</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
