<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Troubleshoot rulebook using CURL and extra_vars :: Product Enablement: Event-Driven Ansible Troubleshooting Lab</title>
    <link rel="prev" href="section1.html">
    <link rel="next" href="section3.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/troubleshooting-eda/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="troubleshooting-eda" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">Troubleshooting the rulebook using CURL</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section2.html">Troubleshoot rulebook using CURL and extra_vars</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section3.html">Configure Event-Driven to pass extra variables to Ansible Automation Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section4.html">Configure Event-Driven to pass extra variables to Ansible Automation Platform</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section5.html">Let&#8217;s configure Event-Driven and Ansible Automation Platform to fix issues coming from Zabbix</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Product Enablement: Event-Driven Ansible Troubleshooting Lab</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Product Enablement: Event-Driven Ansible Troubleshooting Lab</a></li>
    <li><a href="section2.html">Troubleshoot rulebook using CURL and extra_vars</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Troubleshoot rulebook using CURL and extra_vars</h1>
<div class="sect1">
<h2 id="in_this_bfx"><a class="anchor" href="#in_this_bfx"></a>What is in this break-fix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you will troubleshoot SSH authentication and user configuration issues in an Event-Driven Ansible (Automation Decisions) workflow while exploring the use of <code>extra_vars</code> in the rulebook.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SSH into the <strong>node1</strong> instance from the bastion host.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ssh node1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[lab-user@bastion ~]$ ssh node1
Last login: Fri Nov 29 06:30:21 2024 from 192.168.0.33
[ec2-user@node1 ~]$</pre>
</div>
</div>
</li>
<li>
<p>Navigate to the <em>02-lab</em> directory.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd 02-lab
ls</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 ~]$ cd 02-lab
[ec2-user@node1 02-lab]$ ls
hello-rh1.yml  inventory.yml  webhook-example.yml
[ec2-user@node1 02-lab]$</pre>
</div>
</div>
</li>
<li>
<p>Review the rulebook, playbook, and inventory files in the lab directory and try to understand their purpose.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">less webhook-example.yml
less hello-rh1.yml
less inventory.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>ansible-rulebook</code> command from the directory <em>02-lab/</em> in the terminal as shown below.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[ec2-user@node1 02-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events
2024-11-29 15:24:45,039 - ansible_rulebook.app - INFO - Starting sources
2024-11-29 15:24:45,039 - ansible_rulebook.app - INFO - Starting rules
. . .
2024-12-17 16:31:17,566 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-12-17 16:31:17 566 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected
2024-12-17 16:31:17,567 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-12-17 16:31:17,567 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook</pre>
</div>
</div>
</li>
<li>
<p>Open another terminal on the bastion node and run the <code>curl</code> command as specified.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl -H 'Content-Type: application/json' -d '{"event_name": "Hello", "host_host": "node1" }' node1:5000/endpoint</code></pre>
</div>
</div>
</li>
<li>
<p>In the terminal where you ran the <code>ansible-rulebook</code> command, observe the output.</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>2024-11-29 15:26:18,350 - aiohttp.access - INFO - 192.168.0.18 [29/Nov/2024:15:26:18 +0000] "POST /endpoint HTTP/1.1" 200 158 "-" "curl/7.76.1"

** 2024-11-29 15:26:18.350626 [received event]

. . .

PLAY [Install tcpdump] ***********************************************

TASK [Gathering Facts] *********************************************************
fatal: [node1]: UNREACHABLE! =&gt; {"changed": false, "msg": "Failed to connect to the host via ssh: root@node1: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).", "unreachable": true}

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
node1                      : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0

. . .

2024-11-29 15:26:21,603 - ansible_rulebook.action.run_playbook - ERROR -
PLAY [create env] **************************************************************

. . .

PLAY [Install tcpdump] ***********************************************

TASK [Gathering Facts] *********************************************************
fatal: [node1]: UNREACHABLE! =&gt; {"changed": false, "msg": "Failed to connect to the host via ssh: root@node1: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).", "unreachable": true}

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
node1                      : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"Failed to connect to the host via ssh:" You will need to use the access key of the bastion host and the lab-user user."
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Break out of the rulebook by kbd:[Ctrl-C] and note the error generated after the event is captured by the <code>ansible-rulebook</code> command and try to resolve it.</p>
</li>
</ol>
</div>
<hr>
<div class="paragraph">
<p><strong>PAUSE</strong></p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_before_moving_ahead"><a class="anchor" href="#_before_moving_ahead"></a>Before moving ahead</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_please_take_a_moment_to_solve_the_challenge_on_your_own"><a class="anchor" href="#_please_take_a_moment_to_solve_the_challenge_on_your_own"></a>Please take a moment to solve the challenge on your own.</h3>
<div class="paragraph">
<p><strong>The real value of this activity lies in your effort to troubleshoot independently.</strong></p>
</div>
<div class="paragraph">
<p><strong>Once you have tried, continue to the next section for guided steps to verify your approach or learn an alternate solution.</strong></p>
</div>
<hr>
<div class="paragraph">
<p><strong>CONTINUE</strong></p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guided_solution"><a class="anchor" href="#guided_solution"></a>Guided solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Note the error generated after the event is captured by the <code>ansible-rulebook</code> command</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>Failed to connect to the host via ssh: root@node1: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</pre>
</div>
</div>
<div class="paragraph">
<p>This indicates a failure to connect to the node by SSH.</p>
</div>
</li>
<li>
<p>Copy the SSH config and key files from the <code>lab-user</code> on the <strong>bastion</strong> to the <code>ec2-user</code> on <strong>node1</strong> to enable passwordless SSH authentication from <strong>node1</strong> to itself.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd ~/.ssh
ls
scp config *.p* ec2-user@node1:.ssh/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[lab-user@bastion ~]$ cd .ssh/
[lab-user@bastion .ssh]$ ls
authorized_keys  config  known_hosts  known_hosts.old  xjvz8key.pem  xjvz8key.pub
[lab-user@bastion .ssh]$
[lab-user@bastion .ssh]$ scp config *.p* ec2-user@node1:.ssh/
config                                                                                                             100%  216   304.2KB/s   00:00
xjvz8key.pem                                                                                                       100% 2602     5.3MB/s   00:00
xjvz8key.pub                                                                                                       100%  552   353.7KB/s   00:00
[lab-user@bastion .ssh]$</pre>
</div>
</div>
</li>
<li>
<p>Login back to <strong>node1</strong> and try to SSH to itself.</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>[lab-user@bastion .ssh]$ ssh node1
Last login: Fri Nov 29 16:11:55 2024 from 192.168.0.18
[ec2-user@node1 ~]$
[ec2-user@node1 ~]$ ssh node1
Last login: Fri Nov 29 16:19:17 2024 from 192.168.0.18
[ec2-user@node1 ~]$</pre>
</div>
</div>
</li>
<li>
<p>Re-run the rulebook if it is not already running and send the event using the <code>curl</code> command as earlier.</p>
<div class="listingblock">
<div class="title">Output</div>
<div class="content">
<pre>TASK [Gathering Facts] *********************************************************
fatal: [node1]: UNREACHABLE! =&gt; {"changed": false, "msg": "Failed to create temporary directory. In some cases, you may have been able to authenticate and did not have permissions on the target directory. Consider changing the remote tmp path in ansible.cfg to a path rooted in \"/tmp\", for more error information use -vvv. Failed command was: ( umask 77 &amp;&amp; mkdir -p \"` echo Please login as the user \"ec2-user\" rather than the user \"root\"./.ansible/tmp `\"&amp;&amp; mkdir \"` echo Please login as the user \"ec2-user\" rather than the user \"root\"./.ansible/tmp/ansible-tmp-1732897310.5139034-2830-144138432594257 `\" &amp;&amp; echo ansible-tmp-1732897310.5139034-2830-144138432594257=\"` echo Please login as the user \"ec2-user\" rather than the user \"root\"./.ansible/tmp/ansible-tmp-1732897310.5139034-2830-144138432594257 `\" ), exited with result 142, stdout output: Please login as the user \"ec2-user\" rather than the user \"root\".\n\n", "unreachable": true}</pre>
</div>
</div>
</li>
<li>
<p>Note the new error captured this time:</p>
<div class="listingblock">
<div class="content">
<pre>Please login as the user \"ec2-user\" rather than the user \"root\"</pre>
</div>
</div>
</li>
<li>
<p>Ensure you are in the <em>02-lab</em> directory on <strong>node1</strong>.</p>
</li>
<li>
<p>Edit the <em>hello-rh1.yml</em> playbook and change <code>remote_user: root</code> to <code>remote_user: ec2-user</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vi hello-rh1.yml</code></pre>
</div>
</div>
</li>
<li>
<p>While the rulebook is still running on <strong>node1</strong>, send the event from the <strong>bastion</strong> host again.</p>
</li>
<li>
<p>Note that the playbook runs successfully this time, and the <code>Install tcpdump</code> task is executed. kbd:[Ctrl-C] to exit the rulebook on node1 and continue to the next section.</p>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section1.html">Troubleshooting the rulebook using CURL</a></span>
  <span class="next"><a href="section3.html">Configure Event-Driven to pass extra variables to Ansible Automation Platform</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
